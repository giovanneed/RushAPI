<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta author="Cristóferson Bueno" />
<meta contact="cbueno81 at google mail" />
<title>Roteiro da Copa - Prefeitura de Belo Horizonte</title>
<style type="text/css">
@import url(css/style.css);
</style>
<script src="javascript/jquery-1.4.3.min.js" type="text/javascript"></script>
<script src="javascript/jquery-ui-1.8.5.custom.min.js" type="text/javascript"></script>
<script src="javascript/javascript.js" type="text/javascript"></script>
<!--script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false&language=pt-BR"></script--> <!-- Verificar para pegar o idoma pelo parâmetro -->
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
<script type="text/javascript">

	/* 
	 * Otimizar código, criar objetos de placemarkers e carregar todas as informações nestes objetos, para diminuir o roundup na api do Google, evitando assim de estourar o limite de requisições.
	 - Ex:	placemarkers.hotels[id].address = geocodedAddress;
			placemarkers.hotels[id].photo = hotel[id].photo;
			
	 - array placemarkers construido apenas na inicialização;
	 
	 * Modularizar operação de reverseGeocode para sanatizar o código;
	*/

	var map;
	var bounds;
	var geocoder;
	var markers = [];
	var allHotelsMarkers = [];
	var directionDisplay;
	var directionsService;

	function initialize() {
		var latlng = new google.maps.LatLng(-19.815730, -43.954222);
		var myOptions = {
			zoom: 12,
			center: latlng,
			mapTypeId: google.maps.MapTypeId.ROADMAP
		};

		map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
		geocoder = new google.maps.Geocoder();

		var rendererOptions = {
			draggable: true
		};
		
		directionsService = new google.maps.DirectionsService();
		directionsRenderer = new google.maps.DirectionsRenderer(rendererOptions);
		bounds = new google.maps.LatLngBounds();
		
		directionsRenderer.setMap(map);
		directionsRenderer.setPanel(document.getElementById('directionsPanel'));
		
		var currentwindow = null;
		/*
		google.maps.event.addListener(map, "click", function() { 
			if (currentwindow) { 
				currentwindow.close(); 
			}
		});
		*/
	}

	function reverseGeocode() {
		return geocoder.geocode({latLng:map.getCenter()},reverseGeocodeResult);
	}
	
	function reverseGeocodeResult(results, status) {
		if(status == 'OK') {
			if(results.length == 0) {
				return 'Endereço não encontrado';
			} else {
				return results[0].formatted_address;
			}
		} else {
			return 'Erro';
		}
	}

	/* Select event handler */
	var flag = true;
	function resetIndex(selObj) {
		if(flag) selObj.selectedIndex = -1;
		flag = true;
	}
	
	function centerMap(selObj, type) {
		flag = false;
		var location = getLatLong(selObj.value);
        map.setCenter(location);
		addMarkerAtCenter(type);
		
		if(markers.lenght == 2) {
			bounds.extend(new google.maps.LatLng(markers[0], markers[1]));
			map.fitBounds(bounds);
		}
	}
	
	function getLatLngText() {
		return '(' + map.getCenter().lat() +', '+ map.getCenter().lng() +')';
	}
	
	function addMarkerAtCenter(type) {

		if(type == 'fields') {
			ico = 'http://google-maps-icons.googlecode.com/files/soccer.png';
		} else {
			ico = 'http://google-maps-icons.googlecode.com/files/hotel.png';
		}
	
		var image = new google.maps.MarkerImage(ico,
			// This marker is 20 pixels wide by 32 pixels tall.
			new google.maps.Size(41, 41),
			// The origin for this image is 0,0.
			new google.maps.Point(0,0),
			// The anchor for this image is the base of the flagpole at 0,32.
			new google.maps.Point(20, 20));
	
		var marker = new google.maps.Marker({
			position: map.getCenter(),
			icon: image,
			map: map
		});
	
		var geoCoderAddress = '';
		var infowindow = new google.maps.InfoWindow();
	
		var latlng = map.getCenter();
		geocoder.geocode({'latLng': latlng}, function(results, status) {
			if (status == google.maps.GeocoderStatus.OK) {
				if (results[1]) {

					geoCoderAddress = results[0].formatted_address;
					
				} else {
					//alert("No results found");
					geoCoderAddress = 'No address found';
				}
			} else {
				//alert("Geocoder failed due to: " + status);
				geoCoderAddress = 'Geocoder failed due to: ' + status;
			}
			
			var infoContent = '<div style="height:250px;width:250px"><p>' + geoCoderAddress + '</p><div id="fmtAddrss"><img src="http://cbk0.google.com/cbk?output=thumbnail&w=190&h=168&ll=' + map.getCenter().lat() + ',' + map.getCenter().lng() + '" /></div>';
			
			infowindow.setContent(infoContent);
			
			google.maps.event.addListener(marker, 'click', function() {
				infowindow.open(map,marker);
			});
			
			/*
			if(markers.length == 2)
				clearMarkers();
			*/
			
			//currentwindow = infowindow;
			marker.info = infowindow;
			markers.push(marker);
		});
	}
	
	/* Clear Markers */
	function clearMarkers() {
		// clear all markers
		$(markers).each(function () {
			this.info.close();
			this.setMap(null);
		});

		// reset the eviction array 
		markers = [];
	}
	
	function clearHotelsMarkers() {
		$(allHotelsMarkers).each(function () {
			this.info.close();
			this.setMap(null);
		});

		// reset the eviction array 
		allHotelsMarkers = [];
	}
	
	
	function getLatLong(value) {
		var coordinates = value.replace(/,/g, ".").split(';');
		var latitude = coordinates[0];
		var longitude = coordinates[1];
		return new google.maps.LatLng(latitude, longitude)
	}
	
	/* Calc route */
	function calcRoute(way) {
		if(way == 'leftToRight') {
			var start = getLatLong(document.getElementById("hotels_list").value);
			var end = getLatLong(document.getElementById("fields_list").value);
		} else {
			var start = getLatLong(document.getElementById("fields_list").value);
			var end = getLatLong(document.getElementById("hotels_list").value);
		}

		var request = {
			origin: start,
			destination: end,
			optimizeWaypoints: true,
			travelMode: google.maps.DirectionsTravelMode.DRIVING,
			unitSystem: google.maps.DirectionsUnitSystem.METRIC //,
			/*provideRouteAlternatives: true //Necessário tratar o CSS e verificar porque a lista de passos não atualiza */
		};
		
		directionsService.route(request, function(response, status) {
			if (status == google.maps.DirectionsStatus.OK) {
				clearMarkers();
				if(allHotels)
					toggleAllHotels();
				directionsRenderer.setDirections(response);
				
				$('#summaryPanel').prepend("<span style=\"color: #ffffff\"><strong>Distance: " +computeTotalDistance(directionsRenderer.directions)+ "</strong></span>");
				$('#summaryPanel').append('</div><button id="playRouteBtn" class="button gray top-right" onclick="playRoute()">Play Route &raquo;</button>');
				
				$('#summaryPanel').css('display', 'block');
			} else {
				alert('Error: ' + status);
			}
		});
	}
	
	function playRoute() {
		alert('Street View');
	}
	
	/* Calculate Distance */
	function computeTotalDistance(result) {
		var total = 0;
		var myroute = result.routes[0];
		for (i = 0; i < myroute.legs.length; i++) {
			total += myroute.legs[i].distance.value;
		}
		//total = total / 1000.
		total = total / 1000;
		return total + " km";
	} 
	
	var allHotels = false;
	function toggleAllHotels() {
		if(!allHotels) {
			allHotels = true;
			//alert('Adicionar Markers');
			$.each($("#hotels_list"), function(index, value) {
				$('option', this).each(function(index, option) {
					var location = getLatLong(option.value);
					
					ico = 'http://google-maps-icons.googlecode.com/files/hotel.png';
					
					var image = new google.maps.MarkerImage(ico,
						// This marker is 20 pixels wide by 32 pixels tall.
						new google.maps.Size(41, 41),
						// The origin for this image is 0,0.
						new google.maps.Point(0,0),
						// The anchor for this image is the base of the flagpole at 0,32.
						new google.maps.Point(20, 20));
					
					var marker = new google.maps.Marker({
						position: location,
						icon: image,
						map: map
					});

					var geoCoderAddress = '';
					var infowindow = new google.maps.InfoWindow();
				
					var latlng = location;
					
					geocoder.geocode({'latLng': latlng}, function(results, status) {
						if (status == google.maps.GeocoderStatus.OK) {
							if (results[1]) {

								geoCoderAddress = results[0].formatted_address;
								
							} else {
								//alert("No results found");
								geoCoderAddress = 'No address found';
							}
						} else {
							//alert("Geocoder failed due to: " + status);
							geoCoderAddress = 'Geocoder failed due to: ' + status;
						}
						
						var infoContent = '<div style="height:250px;width:250px"><p>' + geoCoderAddress + '</p><div id="fmtAddrss"><img src="http://cbk0.google.com/cbk?output=thumbnail&w=190&h=168&ll=' + location.lat() + ',' + location.lng() + '" /></div>';
						
						infowindow.setContent(infoContent);
						
						google.maps.event.addListener(marker, 'click', function() {
							infowindow.open(map,marker);
						});
						
						//currentwindow = infowindow;
						marker.info = infowindow;
						allHotelsMarkers.push(marker);
					});

					bounds.extend(location);
				});
			});
			
			$("#allHotelsBtn").html("Hidde Hotels &raquo;");
		} else {
			allHotels = false;
			clearHotelsMarkers();
			$("#allHotelsBtn").html("Show Hotels &raquo;");
		}
		if(allHotels)
			map.fitBounds(bounds);
	} 
	
	function printMap() {
		alert('Call Google Maps Static API');
	}
	
	/* Preload the scrollbar images to prevent flickering when changing states. */
	(new Image()).src = "resources/corner-inactive.png";
	(new Image()).src = "resources/corner.png";
	/*
	(new Image()).src = "resources/horizontal-button-active.png";
	(new Image()).src = "resources/horizontal-button-background-active.png";
	(new Image()).src = "resources/horizontal-button-background-hover.png";
	(new Image()).src = "resources/horizontal-button-background-inactive.png";
	(new Image()).src = "resources/horizontal-button-background.png";
	(new Image()).src = "resources/horizontal-button-hover.png";
	(new Image()).src = "resources/horizontal-button-inactive.png";
	(new Image()).src = "resources/horizontal-button.png";
	(new Image()).src = "resources/horizontal-decrement-arrow.png";
	(new Image()).src = "resources/horizontal-increment-arrow.png";
	(new Image()).src = "resources/horizontal-thumb-active.png";
	(new Image()).src = "resources/horizontal-thumb-hover.png";
	(new Image()).src = "resources/horizontal-thumb-inactive.png";
	(new Image()).src = "resources/horizontal-thumb.png";
	(new Image()).src = "resources/horizontal-track-active.png";
	(new Image()).src = "resources/horizontal-track-disabled.png";
	(new Image()).src = "resources/horizontal-track-hover.png";
	(new Image()).src = "resources/horizontal-track.png";
	*/
	(new Image()).src = "resources/resizer-inactive.png";
	(new Image()).src = "resources/resizer.png";
	(new Image()).src = "resources/vertical-button-active.png";
	(new Image()).src = "resources/vertical-button-background-active.png";
	(new Image()).src = "resources/vertical-button-background-hover.png";
	(new Image()).src = "resources/vertical-button-background-inactive.png";
	(new Image()).src = "resources/vertical-button-background.png";
	(new Image()).src = "resources/vertical-button-hover.png";
	(new Image()).src = "resources/vertical-button-inactive.png";
	(new Image()).src = "resources/vertical-button.png";
	(new Image()).src = "resources/vertical-decrement-arrow.png";
	(new Image()).src = "resources/vertical-increment-arrow.png";
	(new Image()).src = "resources/vertical-thumb-active.png";
	(new Image()).src = "resources/vertical-thumb-hover.png";
	(new Image()).src = "resources/vertical-thumb-inactive.png";
	(new Image()).src = "resources/vertical-thumb.png";
	(new Image()).src = "resources/vertical-track-active.png";
	(new Image()).src = "resources/vertical-track-disabled.png";
	(new Image()).src = "resources/vertical-track-hover.png";
	(new Image()).src = "resources/vertical-track.png";
</script>
</head>
<body onload="initialize()">
  <hr id="header_stripe"/>
  <div id="page_container">
  <a class="pbh" href="http://www.pbh.gov.br"><img src="images/pbh.png" alt="Prefeitura de Belo Horizonte" /></a>
  <button id="allHotelsBtn" class="button gray top-right" onclick="toggleAllHotels()">Show Hotels &raquo;</button>
  <button id="printBtn" class="button gray top-right" onclick="printMap()">Print &raquo;</button>
  <div id="toppanel">
    <div id="panel">
		<div id="panel_contents"></div>
		<h1>World Cup 2014 in Belo Horizonte</h1>
		<label class="lblHoteis" for="hotels_list">Hotels</label>
		<div class="border_hotels">
			<select name="hotels" id="hotels_list" multiple="multiple" onchange="centerMap(this, 'hotel')" onclick="resetIndex(this)">
				<option name="hotels_latlong" value="-19,913996;-43,937427">Hotel 1 - Centro</option>
				<option name="hotels_latlong" value="-19,879090;-43,977499">Hotel 2 - São Luiz</option>
				<option name="hotels_latlong" value="-19,930024;-43,947327">Hotel 3 - Centro</option>
				<option name="hotels_latlong" value="-19,964798;-43,955263">Hotel 4 - Belvedere</option>
			</select>
		</div>
		<div class="directions">
			<img class="leftToRight" src="images/leftToRight.png" alt="Rota do Hotel para Centro de Treinamento" onclick="calcRoute('leftToRight')" />
			<img class="rightToLeft" src="images/rightToLeft.png" alt="Rota do Centro de Treinamento para o Hotel" onclick="calcRoute('rightToLeft')" />
		</div>
		<label class="lblCts" for="fields_list">Trainning Centers</label>
		<div class="border_fields" id="fields">
			<select name="fields" id="fields_list" multiple="multiple" onchange="centerMap(this, 'fields')" onclick="resetIndex(this)">
				<option name="fields_latlong" value="-19,743358;-43,956835">Cidade do Galo</option>
				<option name="fields_latlong" value="-19,861291;-43,996725" >Toca da Raposa I</option>
				<option name="fields_latlong" value="-19,833762;-44,004836" >Toca da Raposa II</option>
				<option name="fields_latlong" value="-19,854742;-44,013526" >América - CT Lanna Drumond</option>
				<option name="fields_latlong" value="-19,852986;-43,951954" >Jaraguá Country Clube</option>
				<option name="fields_latlong" value="-20,160700;-43,957243" >Minas Tênis Náutico Clube</option>
				<option name="fields_latlong" value="-19,924305;-43,991532" >PUC - Coração Eucarístico</option>
			</select>
		</div>
    </div>
    <div class="panel_button" style="display: visible;"><img src="images/expand.png"  alt="expand"/><a href="#">Routes</a></div>
    <div class="panel_button" id="hide_button" style="display: none;"><img src="images/collapse.png" alt="collapse" /><a href="#">Hidde</a></div>
  </div>
  <div id="content">
  <div id="map_wrap">
  	<div id="map_canvas"></div>
	<div id="panorama"></div>
	<div id="summaryPanel">
		<!--a class="closePanel">Fechar</a-->
		<div class="transparency movePanel"></div>
		<div id="directionsPanel"></div>
	</div>  
  </div>
  </div>
  <div id="footer">
	<p>Desenvolvido por Geoprocessamento Coorporativo - Prodabel, Prefeitura de Belo Horizonte &copy; 2010</p>
  </div>
</div>
</body>
</html>